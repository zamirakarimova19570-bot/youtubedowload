name: Run Telegram Bot

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */3 * * *'  # Har 3 soatda

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg python3-pip
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot==20.3
        pip install yt-dlp
        pip install python-dotenv
    
    - name: Create .env file from secrets
      run: |
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
        echo "# Bot created by Isoqov Mironshoh" >> .env
        echo "MAX_SIZE=40" >> .env
        echo "TIMEOUT=300" >> .env
    
    - name: Verify token is set
      run: |
        if [ -z "${{ secrets.BOT_TOKEN }}" ]; then
          echo "âŒ ERROR: BOT_TOKEN secret is empty!"
          echo "Please add BOT_TOKEN to GitHub Secrets"
          exit 1
        else
          echo "âœ… BOT_TOKEN is set (first 10 chars): ${BOT_TOKEN:0:10}..."
          echo "ğŸ‘¤ Bot by Isoqov Mironshoh"
        fi
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
    
    - name: List files for debugging
      run: |
        echo "ğŸ“ Current directory:"
        ls -la
        echo -e "\nğŸ“„ .env file content (masked):"
        head -2 .env
        echo "*** [TOKEN MASKED] ***"
    
    - name: Run Telegram Bot
      env:
        # âœ… TOKENNI TO'G'RI UZATISH
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        echo "ğŸš€ Starting Telegram Bot..."
        echo "ğŸ‘¤ Developed by Isoqov Mironshoh"
        echo "â° Time: $(date)"
        echo "ğŸ“¦ Max video size: 40MB"
        echo "â³ Wait time: 5 seconds"
        
        # Botni ishga tushirish
        python bot.py &
        BOT_PID=$!
        
        echo "âœ… Bot started with PID: $BOT_PID"
        
        # Botni 30 soniya monitor qilish
        sleep 30
        
        # Bot hali ham ishlayotganligini tekshirish
        if ps -p $BOT_PID > /dev/null; then
          echo "ğŸ‰ Bot is running successfully!"
          echo "ğŸ¤– Ready to download YouTube videos"
          echo "ğŸ‘¤ Isoqov Mironshoh"
          
          # Botni to'xtatmasdan ishlashiga ruxsat berish
          wait $BOT_PID
        else
          echo "âŒ Bot stopped unexpectedly!"
          exit 1
        fi
